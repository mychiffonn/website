---
import "@/styles/callout.css"

import { Image } from "astro:assets"
import { render } from "astro:content"

import { SITE } from "@site-config"
import { PostManager } from "@/lib/blog"
import Layout from "@/layouts/Layout.astro"
import BackToTop from "@/components/base/BackToTop.astro"
import Badge from "@/components/base/Badge.astro"
import Icon from "@/components/base/Icon.astro"
import PostMetadata from "@/components/blog/PostMetadata.astro"
import PostNav from "@/components/blog/PostNavigation.astro"
import SubpostsFloat from "@/components/blog/SubpostsFloat.astro"
import SubpostsHeader from "@/components/blog/SubpostsHeader.astro"
import SubpostsSidebar from "@/components/blog/SubpostsSidebar.astro"
import TOCFloat from "@/components/blog/TOCFloat.astro"
import TOCHeader from "@/components/blog/TOCHeader.astro"
import TOCSidebar from "@/components/blog/TOCSidebar.astro"
import Breadcrumbs from "@/components/layout/Breadcrumbs.astro"
import SlideOut from "@/components/layout/SlideOut.astro"

export async function getStaticPaths() {
  const posts = await PostManager.getInstance().getAllPostsAndSubposts()
  return posts.map((post) => ({
    params: { id: post.id },
    props: post
  }))
}

const post = Astro.props
if (!post) {
  throw new Error(`Blog post not found: ${post}`)
}

const postManager = PostManager.getInstance()
const currentPostId = post.id

// Get complete optimized context with minimal queries
const [{ Content }, context] = await Promise.all([
  render(post),
  postManager.getPostContext(currentPostId, SITE.tocMaxDepth)
])

const {
  metadata,
  navigation,
  tocSections,
  headings,
  parentPost,
  isSubpost,
  hasSubposts,
  postNavItems,
  activePostNavItem
} = context
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={typeof post.data.image === "string" ? post.data.image : post.data.image?.src}
  type="article"
  publishedTime={post.data.createdAt}
  modifiedTime={post.data.updatedAt}
  author={metadata.authors[0]?.name}
  tags={post.data.tags}
  section="Blog"
>
  {
    (hasSubposts || isSubpost) && activePostNavItem && (
      <SubpostsHeader
        slot="subposts-navigation-header"
        currentPost={post}
        parentPost={navigation.parent}
        postNavItems={postNavItems}
        isSubpost={isSubpost}
        activePostNavItem={activePostNavItem}
      />
    )
  }
  {headings.length > 1 && <TOCHeader slot="toc-header" headings={headings} />}
  <Breadcrumbs
    slot="breadcrumb"
    items={[
      { href: "/blog", label: "Blog", icon: "blog" },
      ...(isSubpost && parentPost
        ? [
            {
              href: `/blog/${parentPost.id}`,
              label: parentPost.title,
              icon: "parent-post"
            },
            {
              href: `/blog/${currentPostId}`,
              label: post.data.title,
              icon: "subpost"
            }
          ]
        : [
            {
              href: `/blog/${currentPostId}`,
              label: post.data.title,
              icon: "post-active"
            }
          ])
    ]}
  />
  {/** Hero image */}
  {
    post.data.image && (
      <Image
        src={post.data.image}
        alt={post.data.title}
        width={1200}
        height={630}
        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1200px"
        class="mx-auto w-full object-cover"
        loading="lazy"
      />
    )
  }

  {/** Post header */}
  <header class="flex flex-col gap-y-4 text-center">
    <h1 id="post-title" class="scroll-mt-31 text-3xl leading-tight font-medium sm:text-4xl">
      {post.data.title}
    </h1>

    {/** Post metadata */}
    <PostMetadata {...metadata} variant="full" />

    {/** Tags */}
    {
      post.data.tags?.length > 0 && (
        <ul class="flex flex-wrap justify-center gap-2" aria-label="Post tags">
          {post.data.tags.map((tag: string) => (
            <li role="listitem">
              <Badge href={`/tags/${tag}`} variant="muted">
                <Icon name="hashtag" class="size-3" />
                {tag}
              </Badge>
            </li>
          ))}
        </ul>
      )
    }
  </header>

  {/** Top navigation */}
  <PostNav prevPost={navigation.newer} nextPost={navigation.older} parentPost={navigation.parent} />

  {/** Left sidebar - TOC */}
  <SlideOut position="left">
    {
      tocSections.length > 0 && (
        <TOCSidebar slot="main" sections={tocSections} currentPostId={currentPostId} />
      )
    }
    {headings.length > 0 && <TOCFloat slot="summary" headings={headings} />}
  </SlideOut>

  {/** Right sidebar - Subposts */}
  {
    (hasSubposts || isSubpost) && activePostNavItem && (
      <SlideOut position="right">
        <SubpostsSidebar
          slot="main"
          postNavItems={postNavItems}
          activePostNavItem={activePostNavItem}
        />
        <SubpostsFloat
          slot="summary"
          postNavItems={postNavItems}
          activePostNavItem={activePostNavItem}
        />
      </SlideOut>
    )
  }

  {/** Main article content */}
  <article class="post-content prose lg:prose-lg">
    <Content />
  </article>

  {/** Bottom navigation */}
  <PostNav prevPost={navigation.newer} nextPost={navigation.older} parentPost={navigation.parent} />
</Layout>

<BackToTop />
