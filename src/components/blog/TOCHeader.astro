---
import type { MarkdownHeading } from "astro"

import { getHeadingMargin } from "@/lib/blog/toc"
import { cn } from "@/lib/utils"
import Icon from "@/components/base/Icon.astro"
import TOCHeadingLink from "@/components/blog/TOCHeadingLink.astro"
import { ScrollArea } from "@/components/ui/scroll-area"

interface Props {
  headings: MarkdownHeading[]
}

const { headings } = Astro.props
const hasHeadings = headings && headings.length > 0
---

{
  hasHeadings && (
    <nav id="mobile-toc-container" class="w-full xl:hidden" aria-label="Table of contents">
      <details class="group overflow-x-hidden" aria-expanded="false">
        <summary
          class={cn(
            "focus-visible:ring-ring focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:outline-none",
            "flex w-full flex-1 cursor-pointer items-start gap-3 p-3"
          )}
        >
          <div
            class="relative flex shrink-0 items-center justify-center"
            role="img"
            aria-label="Reading progress indicator"
          >
            <svg class="size-5" viewBox="0 0 24 24" aria-hidden="true">
              <circle
                class="text-primary/20"
                cx="12"
                cy="12"
                r="10"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              />
              <circle
                id="mobile-toc-progress-circle"
                class="text-primary"
                cx="12"
                cy="12"
                r="10"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-dasharray="62.83"
                stroke-dashoffset="62.83"
                transform="rotate(-90 12 12)"
              />
            </svg>
          </div>
          <span
            id="mobile-toc-current-section"
            class="text-foreground min-w-0 truncate text-sm leading-tight font-medium"
          >
            Overview
          </span>
          <Icon
            name="mingcute:down-line"
            class="text-muted-foreground ml-auto shrink-0 transition-transform duration-200 group-open:rotate-180"
            aria-hidden="true"
          />
        </summary>

        <div class="border-border/50 border-t" data-scroll-container>
          <ScrollArea
            client:load
            className="flex max-h-[30vh] flex-col overflow-y-auto"
            data-scroll-area
          >
            <ul class="flex list-none flex-col gap-y-1 px-3 py-2" id="mobile-toc">
              {headings.map((heading) => (
                <TOCHeadingLink
                  heading={heading}
                  class={cn("text-foreground/70", getHeadingMargin(heading.depth))}
                />
              ))}
            </ul>
          </ScrollArea>
        </div>
      </details>
    </nav>
  )
}

<script>
  import { SITE } from "@site-config"
  import { UnifiedTOCController } from "@/lib/blog/scroll"

  let controller: UnifiedTOCController | null = null

  function initController() {
    controller?.cleanup()
    controller = new UnifiedTOCController(
      "#mobile-toc-container",
      "#mobile-toc-container [data-heading-link]",
      { isMobile: true, tocMaxDepth: SITE.tocMaxDepth }
    )
    controller.init()
  }

  function cleanupController() {
    controller?.cleanup()
    controller = null
  }

  document.addEventListener("astro:page-load", initController)
  document.addEventListener("astro:after-swap", initController)
  document.addEventListener("astro:before-swap", cleanupController)
</script>
