---
import type { Post, PostNavItem as PostNavItemType } from "@/lib/blog/types"
import Icon from "@/components/base/Icon.astro"
import PostNavItem from "@/components/blog/PostNavItem.astro"
import SubpostCountBadge from "@/components/blog/SubpostCountBadge.astro"
import SubpostsList from "@/components/blog/SubpostsList.astro"
import { ScrollArea } from "@/components/ui/scroll-area"

interface Props {
  currentPost: Post
  parentPost?: Post | null
  postNavItems: PostNavItemType[]
  isSubpost?: boolean
  activePostNavItem: PostNavItemType
}

const {
  currentPost,
  parentPost,
  postNavItems = [],
  isSubpost = false,
  activePostNavItem
} = Astro.props

const activePostData = parentPost || currentPost
const currentSubpostDetails = isSubpost
  ? postNavItems.find((item) => item.id === currentPost.id) || null
  : null
const currentTitle = currentSubpostDetails?.title || activePostData.data.title
const subpostCount = postNavItems.length
---

{
  activePostNavItem && subpostCount > 0 && (
    <nav id="mobile-subposts-container" class="w-full xl:hidden" aria-label="Subposts navigation">
      <details class="group" aria-expanded="false">
        <summary class="flex w-full cursor-pointer items-center justify-between p-3">
          <div class="flex flex-1 items-center gap-2">
            <Icon
              name="post-active"
              class="text-primary size-5 shrink-0"
              aria-label={isSubpost ? "Active subpost" : "Active post"}
            />
            <span class="text-foreground flex-1 truncate text-sm leading-tight font-medium">
              {currentTitle}
            </span>
          </div>
          <div class="flex shrink-0 items-center gap-2">
            {subpostCount > 0 && !isSubpost && (
              <SubpostCountBadge count={subpostCount} variant="full" />
            )}
            <Icon
              name="chevron-down"
              class:list={[
                "text-muted-foreground",
                "transition-transform duration-200 group-open:rotate-180"
              ]}
            />
          </div>
        </summary>

        <div class="border-border/50 border-t" data-scroll-container>
          <ScrollArea
            client:load
            className="flex max-h-[30vh] flex-col overflow-y-auto"
            data-scroll-area
          >
            <div class="flex list-none flex-col gap-y-1 px-3 py-2">
              {activePostNavItem && <PostNavItem {...activePostNavItem} />}

              <SubpostsList items={postNavItems} />
            </div>
          </ScrollArea>
        </div>
      </details>
    </nav>
  )
}

<script>
  function initHeader() {
    const container = document.getElementById("mobile-subposts-container")
    if (!container) return

    const detailsElement = container.querySelector("details")
    const links = container.querySelectorAll("a")
    const scrollArea = container.querySelector<HTMLElement>("[data-radix-scroll-area-viewport]")

    if (detailsElement) {
      // This logic should only be attached once.
      // A simple check to prevent duplicate listeners after HMR or swaps.
      if (detailsElement.dataset.initialized) return
      detailsElement.dataset.initialized = "true"

      detailsElement.addEventListener("toggle", () => {
        if (detailsElement.open && scrollArea) {
          requestAnimationFrame(() => {
            const activeItem = scrollArea.querySelector<HTMLElement>("[aria-current='page']")
            if (activeItem) {
              const areaRect = scrollArea.getBoundingClientRect()
              const itemRect = activeItem.getBoundingClientRect()
              const itemTop = itemRect.top - areaRect.top + scrollArea.scrollTop
              const targetScroll = Math.max(0, itemTop - (areaRect.height - itemRect.height) / 2)
              scrollArea.scrollTop = targetScroll
            }
          })
        }
      })
    }

    links.forEach((link) => {
      link.addEventListener("click", () => {
        if (detailsElement) detailsElement.open = false
      })
    })
  }

  document.addEventListener("astro:page-load", initHeader)
  document.addEventListener("astro:after-swap", initHeader)
</script>
