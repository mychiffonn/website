---
import type { PostNavItem as PostNavItemType } from "@/lib/blog/types"
import PostNavItem from "@/components/blog/PostNavItem.astro"
import SubpostsList from "@/components/blog/SubpostsList.astro"
import { ScrollArea } from "@/components/ui/scroll-area"

interface Props {
  postNavItems: PostNavItemType[]
  activePostNavItem: PostNavItemType | null
  class?: string
}

const { postNavItems = [], activePostNavItem, class: className } = Astro.props

// Only render if there's meaningful content
const shouldRender = postNavItems.length > 0 || !!activePostNavItem
---

{
  shouldRender && activePostNavItem && (
    <aside
      id="subposts-sidebar-container"
      class={className}
      role="complementary"
      aria-label="Subposts navigation"
    >
      <header class="border-border sticky top-0 mb-2 border-b pb-1">
        <h2 id="subposts-heading" class="text-foreground/80 text-sm font-semibold">
          Post Navigation
        </h2>
      </header>
      <ScrollArea
        client:load
        className="flex max-h-[calc(100vh-8rem)] flex-col overflow-y-auto"
        data-scroll-container
      >
        <nav aria-label="Post and subposts" class="space-y-1 p-2">
          <PostNavItem {...activePostNavItem} />
          <h3
            id="subposts-heading"
            class="text-muted-foreground my-1 text-xs font-semibold tracking-wider uppercase"
          >
            Subposts
          </h3>
          <SubpostsList items={postNavItems} />
        </nav>
      </ScrollArea>
    </aside>
  )
}

<script>
  function initSidebar() {
    const container = document.getElementById("subposts-sidebar-container")
    if (!container) return

    const scrollArea = container.querySelector<HTMLElement>("[data-radix-scroll-area-viewport]")
    if (!scrollArea) return

    const activeItem = scrollArea.querySelector<HTMLElement>("[aria-current='page']")
    if (!activeItem) return

    // Scroll active item into view
    const areaRect = scrollArea.getBoundingClientRect()
    const itemRect = activeItem.getBoundingClientRect()
    const itemTop = itemRect.top - areaRect.top + scrollArea.scrollTop
    const targetScroll = Math.max(0, itemTop - (areaRect.height - itemRect.height) / 2)
    scrollArea.scrollTop = targetScroll
  }

  document.addEventListener("astro:page-load", initSidebar)
  document.addEventListener("astro:after-swap", initSidebar)
</script>
