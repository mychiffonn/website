---
import type { CollectionEntry } from "astro:content"

import { getContextVariant, getProjectLinks } from "@/lib/projects"
import { cn } from "@/lib/utils"
import Badge from "@/components/base/Badge.astro"
import Button from "@/components/base/Button.astro"
import Icon from "@/components/base/Icon.astro"
import DateRange from "@/components/projects/DateRange.astro"

import "@/styles/card.css"

interface Props {
  project: CollectionEntry<"projects">
}

const { project } = Astro.props
const { title, isHighlighted, fromDate, toDate, code, doc, url, release, context, tags } =
  project.data

const links = getProjectLinks(code, doc, url, release)

const contextVariant = getContextVariant(context)

const descriptionData = project.data.description
  ? { text: project.data.description, needsReadMore: false }
  : project.body?.trim()
    ? (() => {
        const bodyText = project.body.trim()
        const needsTruncation = bodyText.length > 150
        return {
          text: needsTruncation ? bodyText.substring(0, 150) + "..." : bodyText,
          needsReadMore: needsTruncation
        }
      })()
    : null

const hasDetailPage = !!project.body?.trim()

const cardClasses = cn(
  "card card-content",
  isHighlighted && "card-selected",
  hasDetailPage && "card-clickable relative group"
)
---

<article class={cardClasses}>
  {
    hasDetailPage && (
      <a
        href={`/projects/${project.id}`}
        class="absolute inset-0 z-10"
        aria-label={`View details for ${title}`}
      />
    )
  }

  <div class="card-header relative">
    {
      isHighlighted && (
        <>
          <Icon name="star" class="text-primary" />
          <span class="sr-only">Featured</span>
        </>
      )
    }
    <h3 class="card-title">{title}</h3>
  </div>

  {/* Context and Date */}
  <div class="card-meta text-muted-foreground relative">
    {
      context && (
        <Badge variant={contextVariant}>{context.charAt(0).toUpperCase() + context.slice(1)}</Badge>
      )
    }
    <DateRange fromDate={fromDate} toDate={toDate} class="flex gap-1" />
  </div>

  {
    descriptionData && (
      <p class="card-description relative">
        {descriptionData.text}
        {descriptionData.needsReadMore && hasDetailPage && (
          <span class="text-primary ml-1">Read more â†’</span>
        )}
      </p>
    )
  }

  {/* Tags */}
  {
    tags && tags.length > 0 && (
      <div class="card-tags relative">
        {tags.map((tag: string) => (
          <Badge variant="muted" class="text-xs">
            {tag}
          </Badge>
        ))}
      </div>
    )
  }

  {/* Links */}
  {
    links.length > 0 && (
      <div class="card-actions relative z-20">
        {links.map(({ href, icon, label }) => (
          <Button href={href} variant="accent-outline">
            <Icon name={icon} />
            <span>{label}</span>
          </Button>
        ))}
      </div>
    )
  }
</article>
