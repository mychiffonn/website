---
import Button from "@/components/base/Button.astro"
import Icon from "@/components/base/Icon.astro"
---

<Button id="theme-toggle" variant="ghost" size="square" title="Toggle theme">
  <Icon name="mingcute:sun-line" size="1.5rem" class="scale-100 transition-all dark:scale-0" />
  <Icon
    name="mingcute:moon-line"
    size="1.5rem"
    class="absolute scale-0 transition-all dark:scale-100"
  />
  <span class="sr-only">Toggle theme</span>
</Button>

<script is:inline data-astro-rerun>
  ;(() => {
    const localStorageTheme = localStorage?.getItem("theme") ?? ""
    let theme
    if (["dark", "light"].includes(localStorageTheme)) {
      theme = localStorageTheme
    } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      theme = "dark"
    } else {
      theme = "light"
    }

    document.documentElement.setAttribute("data-theme", theme)
    document.documentElement.classList.add(theme === "dark" ? "scheme-dark" : "scheme-light")
    window.localStorage.setItem("theme", theme)
  })()
</script>

<script>
  function handleToggleClick() {
    const element = document.documentElement
    const currentTheme = element.getAttribute("data-theme")
    const newTheme = currentTheme === "dark" ? "light" : "dark"

    element.classList.add("[&_*]:transition-none")
    element.setAttribute("data-theme", newTheme)
    element.classList.remove("scheme-dark", "scheme-light")
    element.classList.add(newTheme === "dark" ? "scheme-dark" : "scheme-light")

    window.getComputedStyle(element).getPropertyValue("opacity")

    requestAnimationFrame(() => {
      element.classList.remove("[&_*]:transition-none")
    })

    localStorage.setItem("theme", newTheme)
  }

  function initThemeToggle() {
    const themeToggle = document.getElementById("theme-toggle")
    if (themeToggle) {
      themeToggle.addEventListener("click", handleToggleClick)
    }
  }

  initThemeToggle()

  document.addEventListener("astro:after-swap", () => {
    const storedTheme = localStorage.getItem("theme") || "light"
    const element = document.documentElement

    element.classList.add("[&_*]:transition-none")

    window.getComputedStyle(element).getPropertyValue("opacity")

    element.setAttribute("data-theme", storedTheme)
    element.classList.remove("scheme-dark", "scheme-light")
    element.classList.add(storedTheme === "dark" ? "scheme-dark" : "scheme-light")

    requestAnimationFrame(() => {
      element.classList.remove("[&_*]:transition-none")
    })

    initThemeToggle()
  })
</script>
